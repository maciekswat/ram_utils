

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ramutils.tasks.classifier &mdash; Ramutils 2.2.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Ramutils
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started_report_data.html">Getting Statrted: RAM Report Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">Serializable data structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classifier.html">Classifier training, cross validation, and utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../events.html">Event processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command-line usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc.html">Miscellaneous utilities</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Ramutils</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ramutils.tasks.classifier</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ramutils.tasks.classifier</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">classiflib</span> <span class="k">import</span> <span class="n">ClassifierContainer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">roc_auc_score</span>

<span class="kn">from</span> <span class="nn">ramutils.classifier.cross_validation</span> <span class="k">import</span> <span class="n">permuted_loso_cross_validation</span><span class="p">,</span> \
    <span class="n">permuted_lolo_cross_validation</span><span class="p">,</span> <span class="n">perform_cross_validation</span>
<span class="kn">from</span> <span class="nn">ramutils.classifier.utils</span> <span class="k">import</span> <span class="n">reload_classifier</span>
<span class="kn">from</span> <span class="nn">ramutils.classifier.utils</span> <span class="k">import</span> <span class="n">train_classifier</span> <span class="k">as</span> <span class="n">train_classifier_core</span>
<span class="kn">from</span> <span class="nn">ramutils.classifier.weighting</span> <span class="k">import</span> \
    <span class="n">get_sample_weights</span> <span class="k">as</span> <span class="n">get_sample_weights_core</span>
<span class="kn">from</span> <span class="nn">ramutils.events</span> <span class="k">import</span> <span class="n">extract_sessions</span><span class="p">,</span> <span class="n">get_nonstim_events_mask</span><span class="p">,</span> \
    <span class="n">get_encoding_mask</span><span class="p">,</span> <span class="n">extract_event_metadata</span>
<span class="kn">from</span> <span class="nn">ramutils.log</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">ramutils.montage</span> <span class="k">import</span> <span class="n">compare_recorded_with_all_pairs</span>
<span class="kn">from</span> <span class="nn">ramutils.powers</span> <span class="k">import</span> <span class="n">reduce_powers</span>
<span class="kn">from</span> <span class="nn">ramutils.reports.summary</span> <span class="k">import</span> <span class="n">ClassifierSummary</span>
<span class="kn">from</span> <span class="nn">ramutils.tasks</span> <span class="k">import</span> <span class="n">task</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;get_sample_weights&#39;</span><span class="p">,</span>
    <span class="s1">&#39;train_classifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39;summarize_classifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39;serialize_classifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39;post_hoc_classifier_evaluation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reload_used_classifiers&#39;</span>
<span class="p">]</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_sample_weights</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">get_sample_weights_core</span><span class="p">(</span><span class="n">events</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sample_weights</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">train_classifier</span><span class="p">(</span><span class="n">pow_mat</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="n">penalty_param</span><span class="p">,</span>
                     <span class="n">penalty_type</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">train_classifier_core</span><span class="p">(</span><span class="n">pow_mat</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span>
                                       <span class="n">penalty_param</span><span class="p">,</span> <span class="n">penalty_type</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">classifier</span>


<div class="viewcode-block" id="serialize_classifier"><a class="viewcode-back" href="../../../pipeline.html#ramutils.tasks.classifier.serialize_classifier">[docs]</a><span class="nd">@task</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serialize_classifier</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span>
                         <span class="n">classifier_summary</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Serialize classifier into a container object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    classifier: sklearn Estimator</span>
<span class="sd">        Model used during training</span>
<span class="sd">    pairs: array_like</span>
<span class="sd">        bipolar pairs used for training</span>
<span class="sd">    features: np.ndarray</span>
<span class="sd">        Normalized power matrix used as features to the classifier</span>
<span class="sd">    events: np.recarray</span>
<span class="sd">        Set of events used for training</span>
<span class="sd">    sample_weights: array_like</span>
<span class="sd">        Weights used for each of the event</span>
<span class="sd">    classifier_summary: ClassifierSummary</span>
<span class="sd">        Object used for calculating and storing cross-validation-related metrics</span>
<span class="sd">    subject: str</span>
<span class="sd">        Subject identifier</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ClassififerContainer</span>
<span class="sd">        Object representing all meta-data associated with training a classifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">ClassifierContainer</span><span class="p">(</span>
        <span class="n">classifier</span><span class="o">=</span><span class="n">classifier</span><span class="p">,</span>
        <span class="n">pairs</span><span class="o">=</span><span class="n">pairs</span><span class="p">,</span>
        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">,</span>
        <span class="n">classifier_info</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">classifier_summary</span><span class="o">.</span><span class="n">auc</span><span class="p">,</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">subject</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">container</span></div>


<div class="viewcode-block" id="summarize_classifier"><a class="viewcode-back" href="../../../pipeline.html#ramutils.tasks.classifier.summarize_classifier">[docs]</a><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">summarize_classifier</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">pow_mat</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">n_permutations</span><span class="p">,</span>
                         <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform LOSO or LOLO cross validation on a classifier.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    classifier : sklearn model object</span>
<span class="sd">    pow_mat : np.ndarray</span>
<span class="sd">    events : np.recarray</span>
<span class="sd">    n_permutations: int</span>
<span class="sd">    tag: str</span>
<span class="sd">        Tag to assign the resulting classifier summary (default:</span>
<span class="sd">        ``&#39;classifier&#39;``)</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        Extra keyword arguments that are passed to get_sample_weights. See</span>
<span class="sd">        that function for more details</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    classifier_summary : ClassifierSummary</span>
<span class="sd">        Results of cross validation as a summary object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recalls</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">recalled</span>
    <span class="n">encoding_event_mask</span> <span class="o">=</span> <span class="n">get_encoding_mask</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="n">encoding_recalls</span> <span class="o">=</span> <span class="n">recalls</span><span class="p">[</span><span class="n">encoding_event_mask</span><span class="p">]</span>

    <span class="c1"># Run leave-one-session-out cross validation when we have &gt; 1 session,</span>
    <span class="c1"># otherwise leave-one-list-out</span>
    <span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">sessions</span> <span class="o">=</span> <span class="n">extract_event_metadata</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="n">permuted_auc_values</span><span class="p">,</span> <span class="n">probs</span> <span class="o">=</span> <span class="n">perform_cross_validation</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span>
                                                          <span class="n">events</span><span class="p">,</span>
                                                          <span class="n">n_permutations</span><span class="p">,</span>
                                                          <span class="n">pow_mat</span><span class="p">,</span>
                                                          <span class="n">recalls</span><span class="p">,</span>
                                                          <span class="n">sessions</span><span class="p">,</span>
                                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">classifier_summary</span> <span class="o">=</span> <span class="n">ClassifierSummary</span><span class="p">()</span>

    <span class="n">classifier_summary</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span>
                                <span class="n">experiment</span><span class="p">,</span>
                                <span class="n">sessions</span><span class="p">,</span>
                                <span class="n">encoding_recalls</span><span class="p">,</span>
                                <span class="n">probs</span><span class="p">,</span>
                                <span class="n">permuted_auc_values</span><span class="p">,</span>
                                <span class="n">frequencies</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;freqs&#39;</span><span class="p">),</span>
                                <span class="n">pairs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pairs&#39;</span><span class="p">),</span>
                                <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                                <span class="n">features</span><span class="o">=</span><span class="n">pow_mat</span><span class="p">,</span>
                                <span class="n">coefficients</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Permutation test p-value = </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classifier_summary</span><span class="o">.</span><span class="n">pvalue</span><span class="p">)</span>
    <span class="n">recall_prob</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">pow_mat</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">insample_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">recalls</span><span class="p">,</span> <span class="n">recall_prob</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in-sample AUC = </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">insample_auc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">classifier_summary</span></div>


<div class="viewcode-block" id="reload_used_classifiers"><a class="viewcode-back" href="../../../pipeline.html#ramutils.tasks.classifier.reload_used_classifiers">[docs]</a><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">reload_used_classifiers</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reload the actual classifiers used in each session of an experiment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject: str</span>
<span class="sd">        Subject identifier</span>
<span class="sd">    experiment: str</span>
<span class="sd">        Name of the experiment</span>
<span class="sd">    sessions: list</span>
<span class="sd">        List of sessions to try reloading a classifier</span>
<span class="sd">    root: str</span>
<span class="sd">        Base path of where to find RHINO files</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of ClassifierContainer objects of length n_sessions</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If a classifier is not found or is unable to be reloaded (legacy storage</span>
<span class="sd">    format, or other issues), then the list of ClassifierContainer objects</span>
<span class="sd">    will have None as the entry for that session.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">used_classifiers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">extract_sessions</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">reload_classifier</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="n">used_classifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">used_classifiers</span></div>


<div class="viewcode-block" id="post_hoc_classifier_evaluation"><a class="viewcode-back" href="../../../pipeline.html#ramutils.tasks.classifier.post_hoc_classifier_evaluation">[docs]</a><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">post_hoc_classifier_evaluation</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">powers</span><span class="p">,</span> <span class="n">all_pairs</span><span class="p">,</span> <span class="n">classifiers</span><span class="p">,</span>
                                   <span class="n">n_permutations</span><span class="p">,</span> <span class="n">retrained_classifier</span><span class="p">,</span>
                                   <span class="n">use_retrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">post_stim_events</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">post_stim_powers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Evaluate a trained classifier</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    events: np.recarray</span>
<span class="sd">        Task events associated with the stim sessesion to be evaluated</span>
<span class="sd">    powers: np.ndarray</span>
<span class="sd">        Normalized mean powers</span>

<span class="sd">    all_pairs: OrderedDict</span>
<span class="sd">        All pairs based on recorded electrodes combine from config file</span>
<span class="sd">    classifiers: List</span>
<span class="sd">        List of classifiers corresponding to each session</span>
<span class="sd">    n_permutations: int</span>
<span class="sd">        Number of permutations to use for cross validation</span>
<span class="sd">    retrained_classifier: classiflib.container.ClassifierContainer</span>
<span class="sd">        classifier container object based on a retrained classifier</span>
<span class="sd">    use_retrained: bool (default False)</span>
<span class="sd">        Indicates if the retrained classifier should be used over the actual</span>
<span class="sd">        classifier for the purpose of evaluation</span>
<span class="sd">    post_stim_events: np.recarray or None</span>
<span class="sd">        Post-stimulation events associated with the stim sessesion to be</span>
<span class="sd">        evaluated. Can be done in the case of FR2 where post stim events</span>
<span class="sd">    post_stim_powers: np.ndarray or None</span>
<span class="sd">        Normalized mean powers for post_stim period events</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of summary objects that are needed in subsequent parts</span>
<span class="sd">        of the processing pipeline. The dictionary will be in the following</span>
<span class="sd">        format::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;cross_session_summary&#39;: MultiSessionClassifierSummary,</span>
<span class="sd">                &#39;classifier_summaries&#39;: List of ClassifierSummary objects,</span>
<span class="sd">                &#39;encoding_classifier_summaries&#39;: List of ClassifierSummary</span>
<span class="sd">                objects built using all encoding events,</span>
<span class="sd">                &#39;post_stim_predicted_probs&#39;: Classifier output during post stim period</span>
<span class="sd">            }</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Different channels could be excluded based on results of artifact detection</span>
<span class="sd">    and stim parameters. Extract the used pairs from the serialized classifier</span>
<span class="sd">    that was used/retrained in order to correctly assess the classifier. The</span>
<span class="sd">    default behavior is to use the retrained classifier for any sessions</span>
<span class="sd">    where the actual classifier was not found or was unable to be loaded.</span>
<span class="sd">    Legacy-formatted classifiers are not supported for re-loading. In cases</span>
<span class="sd">    where a stim session was restarted, the default behavior is to use the</span>
<span class="sd">    original classifier (i.e. the classifier before artifact detection) rather</span>
<span class="sd">    than trying to guess which classifier to load.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">extract_sessions</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classifiers</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The number of sessions for evaluation must match &#39;</span>
                           <span class="s1">&#39;the number of classifiers&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">classifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="p">])</span> <span class="ow">and</span>
            <span class="n">retrained_classifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;A retrained classifier must be passed if any &#39;</span>
                           <span class="s1">&#39;sessions have missing classifiers&#39;</span><span class="p">)</span>
    <span class="n">recalls</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">recalled</span>
    <span class="k">if</span> <span class="n">post_stim_events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">post_stim_recalls</span> <span class="o">=</span> <span class="n">post_stim_events</span><span class="o">.</span><span class="n">recalled</span>

    <span class="c1"># Masks for encoding events</span>
    <span class="n">encoding_mask</span> <span class="o">=</span> <span class="n">get_encoding_mask</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="c1"># This takes care of sub-setting events to encoding non-stim events</span>
    <span class="n">non_stim_mask</span> <span class="o">=</span> <span class="n">get_nonstim_events_mask</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="n">non_stim_recalls</span> <span class="o">=</span> <span class="n">recalls</span><span class="p">[</span><span class="n">non_stim_mask</span><span class="p">]</span>

    <span class="n">classifier_summaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">encoding_classifier_summaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">post_stim_predicted_probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sessions</span><span class="p">):</span>
        <span class="n">classifier_summary</span> <span class="o">=</span> <span class="n">ClassifierSummary</span><span class="p">()</span>
        <span class="n">reloaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Be sure to work with a copy of the classifier object because it will</span>
        <span class="c1"># be re-fit as part of the lolo cross validation and if you pass</span>
        <span class="c1"># a reference, the AUCs will be wacky</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">use_retrained</span><span class="p">):</span>
            <span class="n">classifier_container</span> <span class="o">=</span> <span class="n">retrained_classifier</span>
            <span class="n">reloaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Using the retrained classifier for session </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">classifier_container</span> <span class="o">=</span> <span class="n">classifiers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Using actual classifier for session </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>

        <span class="n">classifier</span> <span class="o">=</span> <span class="n">classifier_container</span><span class="o">.</span><span class="n">classifier</span>
        <span class="n">recorded_pairs</span> <span class="o">=</span> <span class="n">classifier_container</span><span class="o">.</span><span class="n">pairs</span>

        <span class="n">used_mask</span> <span class="o">=</span> <span class="n">compare_recorded_with_all_pairs</span><span class="p">(</span><span class="n">all_pairs</span><span class="p">,</span> <span class="n">recorded_pairs</span><span class="p">)</span>

        <span class="n">session_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">session</span> <span class="o">==</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">session_events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[(</span><span class="n">session_mask</span> <span class="o">&amp;</span> <span class="n">non_stim_mask</span><span class="p">)]</span>
        <span class="n">session_recalls</span> <span class="o">=</span> <span class="n">recalls</span><span class="p">[</span><span class="n">session_mask</span> <span class="o">&amp;</span> <span class="n">non_stim_mask</span><span class="p">]</span>

        <span class="n">session_powers</span> <span class="o">=</span> <span class="n">powers</span><span class="p">[(</span><span class="n">session_mask</span> <span class="o">&amp;</span> <span class="n">non_stim_mask</span><span class="p">)]</span>
        <span class="n">reduced_session_powers</span> <span class="o">=</span> <span class="n">reduce_powers</span><span class="p">(</span><span class="n">session_powers</span><span class="p">,</span> <span class="n">used_mask</span><span class="p">,</span>
                                               <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]))</span>

        <span class="c1"># Manually pass in the weighting scheme here, otherwise the cross</span>
        <span class="c1"># validation procedures will try to determine it for you</span>
        <span class="n">permuted_auc_values</span> <span class="o">=</span> <span class="n">permuted_lolo_cross_validation</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span>
                                                             <span class="n">reduced_session_powers</span><span class="p">,</span>
                                                             <span class="n">session_events</span><span class="p">,</span>
                                                             <span class="n">n_permutations</span><span class="p">,</span>
                                                             <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;EQUAL&#39;</span><span class="p">,</span>
                                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">session_probs</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">reduced_session_powers</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">predicted_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_probs</span><span class="p">)</span>

        <span class="c1"># Calculate classifier outputs during the post stim period. This is</span>
        <span class="c1"># used downstream in the reports to see if stimulation affected the</span>
        <span class="c1"># biomarker</span>
        <span class="k">if</span> <span class="n">post_stim_events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">post_stim_session_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">post_stim_events</span><span class="o">.</span><span class="n">session</span> <span class="o">==</span> <span class="n">session</span><span class="p">)</span>
            <span class="n">post_stim_session_powers</span> <span class="o">=</span> <span class="n">post_stim_powers</span><span class="p">[</span><span class="n">post_stim_session_mask</span><span class="p">]</span>
            <span class="n">post_stim_reduced_session_powers</span> <span class="o">=</span> <span class="n">reduce_powers</span><span class="p">(</span>
                <span class="n">post_stim_session_powers</span><span class="p">,</span> <span class="n">used_mask</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]))</span>
            <span class="n">post_stim_probs</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                <span class="n">post_stim_reduced_session_powers</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">post_stim_predicted_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_stim_probs</span><span class="p">)</span>

        <span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">sessions</span> <span class="o">=</span> <span class="n">extract_event_metadata</span><span class="p">(</span><span class="n">session_events</span><span class="p">)</span>

        <span class="c1"># This is the primary classifier used for evaluation. It is based on</span>
        <span class="c1"># assessing classifier output for non-stim encoding events</span>
        <span class="n">classifier_summary</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span>
                                    <span class="n">session_recalls</span><span class="p">,</span>
                                    <span class="n">session_probs</span><span class="p">,</span>
                                    <span class="n">permuted_auc_values</span><span class="p">,</span>
                                    <span class="n">frequencies</span><span class="o">=</span><span class="n">classifier_container</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span>
                                    <span class="n">pairs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pairs&#39;</span><span class="p">][</span><span class="n">used_mask</span><span class="p">],</span>
                                    <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;session_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">),</span>
                                    <span class="n">reloaded</span><span class="o">=</span><span class="n">reloaded</span><span class="p">,</span>
                                    <span class="n">features</span><span class="o">=</span><span class="n">reduced_session_powers</span><span class="p">,</span>
                                    <span class="n">coefficients</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
        <span class="n">classifier_summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classifier_summary</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AUC for session </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">,</span>
                                                    <span class="n">classifier_summary</span><span class="o">.</span><span class="n">auc</span><span class="p">))</span>

        <span class="c1"># Get a classifier summary for all encoding events. This classifier</span>
        <span class="c1"># is needed in order to match all encoding events to stim information</span>
        <span class="c1"># in a later step</span>
        <span class="n">session_encoding_powers</span> <span class="o">=</span> <span class="n">powers</span><span class="p">[(</span><span class="n">session_mask</span> <span class="o">&amp;</span> <span class="n">encoding_mask</span><span class="p">)]</span>
        <span class="n">reduced_session_encoding_powers</span> <span class="o">=</span> <span class="n">reduce_powers</span><span class="p">(</span><span class="n">session_encoding_powers</span><span class="p">,</span>
                                                        <span class="n">used_mask</span><span class="p">,</span>
                                                        <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]))</span>

        <span class="n">session_encoding_probs</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
            <span class="n">reduced_session_encoding_powers</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">session_encoding_recalls</span> <span class="o">=</span> <span class="n">recalls</span><span class="p">[</span><span class="n">session_mask</span> <span class="o">&amp;</span> <span class="n">encoding_mask</span><span class="p">]</span>

        <span class="n">encoding_classifier_summary</span> <span class="o">=</span> <span class="n">ClassifierSummary</span><span class="p">()</span>
        <span class="n">encoding_classifier_summary</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span>
                                             <span class="n">session_encoding_recalls</span><span class="p">,</span>
                                             <span class="n">session_encoding_probs</span><span class="p">,</span>
                                             <span class="n">permuted_auc_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">frequencies</span><span class="o">=</span><span class="n">classifier_container</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span>
                                             <span class="n">pairs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pairs&#39;</span><span class="p">],</span>
                                             <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;encoding_evaluation&#39;</span><span class="p">,</span>
                                             <span class="n">features</span><span class="o">=</span><span class="n">reduced_session_encoding_powers</span><span class="p">,</span>
                                             <span class="n">coefficients</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
        <span class="n">encoding_classifier_summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoding_classifier_summary</span><span class="p">)</span>

    <span class="c1"># Combine session-specific predicted probabilities into 1D array</span>
    <span class="n">all_predicted_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">permuted_auc_values</span> <span class="o">=</span> <span class="n">permuted_loso_cross_validation</span><span class="p">(</span>
            <span class="n">retrained_classifier</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">powers</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">n_permutations</span><span class="p">,</span>
            <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;EQUAL&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">sessions</span> <span class="o">=</span> <span class="n">extract_event_metadata</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="n">cross_session_summary</span> <span class="o">=</span> <span class="n">ClassifierSummary</span><span class="p">()</span>
    <span class="n">classifier_</span> <span class="o">=</span> <span class="n">retrained_classifier</span><span class="o">.</span><span class="n">classifier</span> <span class="k">if</span> <span class="n">retrained_classifier</span> <span class="k">else</span> <span class="n">classifier</span>
    <span class="n">cross_session_summary</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span>
                                   <span class="n">non_stim_recalls</span><span class="p">,</span>
                                   <span class="n">all_predicted_probs</span><span class="p">,</span>
                                   <span class="n">permuted_auc_values</span><span class="p">,</span>
                                   <span class="n">coefficients</span><span class="o">=</span><span class="n">classifier_</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span>
                                   <span class="n">frequencies</span><span class="o">=</span><span class="n">classifier_container</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span>
                                   <span class="n">pairs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pairs&#39;</span><span class="p">],</span>
                                   <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;Combined Sessions&#39;</span><span class="p">,</span>
                                   <span class="n">reloaded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">features</span><span class="o">=</span><span class="n">classifier_container</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
    <span class="c1"># Leave commented out until we have a way to do multi-stim-session</span>
    <span class="c1"># evaluation, otherwise this classifier is just redundant.</span>
    <span class="c1"># classifier_summaries.append(cross_session_summary)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Combined AUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cross_session_summary</span><span class="o">.</span><span class="n">auc</span><span class="p">))</span>

    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cross_session_summary&#39;</span><span class="p">:</span> <span class="n">cross_session_summary</span><span class="p">,</span>
        <span class="s1">&#39;classifier_summaries&#39;</span><span class="p">:</span> <span class="n">classifier_summaries</span><span class="p">,</span>
        <span class="s1">&#39;encoding_classifier_summaries&#39;</span><span class="p">:</span> <span class="n">encoding_classifier_summaries</span><span class="p">,</span>
        <span class="s1">&#39;post_stim_predicted_probs&#39;</span><span class="p">:</span> <span class="n">post_stim_predicted_probs</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result_dict</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.2.4',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>